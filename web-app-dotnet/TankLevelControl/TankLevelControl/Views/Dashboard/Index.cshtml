@* @model List<TankLevelControl.Models.Tank>

@{
    ViewData["Title"] = "Dashboard Tanques";
}

<style>
    /* ✅ Fondo en toda la ventana */
    body {
        background-image: url('/img/bahia.png');
        background-size: cover;
        background-position: center center;
        background-repeat: no-repeat;
        background-attachment: fixed;
        min-height: 100vh;
    }

    /* ✅ Capa para mejorar contraste (texto legible) */
    .page-overlay {
        min-height: 100vh;
        background: rgba(0,0,0,0.35);
        padding: 10px 0 30px 0;
    }

    .tank-grid {
        display: flex;
        gap: 40px;
        flex-wrap: wrap;
        justify-content: center;
        align-items: flex-start;
        padding: 10px 0 30px 0;
    }

    .tank-card {
        width: 320px;
        text-align: center;
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.10);
        border-radius: 14px;
        padding: 12px 12px 16px 12px;
        backdrop-filter: blur(6px);
    }

    .tank-title {
        font-weight: 700;
        font-size: 22px;
        margin: 10px 0 2px 0;
        color: #fff;
        text-shadow: 0 2px 10px rgba(0,0,0,0.55);
    }

    .tank-sub {
        font-size: 13px;
        margin: 0 0 10px 0;
        opacity: .95;
        color: #fff;
        text-shadow: 0 2px 10px rgba(0,0,0,0.55);
    }

    .tank-stats {
        margin-top: 10px;
        font-size: 14px;
        color: #fff;
        text-shadow: 0 2px 10px rgba(0,0,0,0.55);
    }

    .badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 999px;
        background: rgba(0,0,0,0.75);
        color: #fff;
        font-size: 12px;
        letter-spacing: .3px;
        border: 1px solid rgba(255,255,255,0.15);
    }

    h2 {
        color: #fff;
        text-shadow: 0 2px 14px rgba(0,0,0,0.65);
        text-align: center;
        margin: 20px 0 10px 0;
        padding: 0 14px;
        line-height: 1.2;
    }
</style>

<div class="page-overlay">

    <h2>Control de Nivel de Tanques Centro de Conocimiento e Innovación Bahía de Buenaventura</h2>

    <div class="tank-grid">
        @foreach (var t in Model)
        {
            <div class="tank-card">
                <div class="tank-title">@t.Name</div>
                <div class="tank-sub"><span class="badge">DeviceId: @t.DeviceId</span></div>

                <svg width="280" height="360" viewBox="0 0 280 360" aria-label="Tanque">
                    <defs>
                        <!-- Sombra -->
                        <filter id="shadow-@t.Id" x="-20%" y="-20%" width="140%" height="140%">
                            <feDropShadow dx="0" dy="8" stdDeviation="8" flood-opacity="0.25" />
                        </filter>

                        <!-- Plástico negro -->
                        <linearGradient id="plastic-@t.Id" x1="0" y1="0" x2="1" y2="0">
                            <stop offset="0%" stop-color="#070707" />
                            <stop offset="14%" stop-color="#1a1a1a" />
                            <stop offset="35%" stop-color="#0a0a0a" />
                            <stop offset="60%" stop-color="#222" />
                            <stop offset="82%" stop-color="#0b0b0b" />
                            <stop offset="100%" stop-color="#050505" />
                        </linearGradient>

                        <!-- Agua -->
                        <linearGradient id="water-@t.Id" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0%" stop-color="#7dd3fc" stop-opacity="0.95" />
                            <stop offset="55%" stop-color="#0ea5e9" stop-opacity="0.95" />
                            <stop offset="100%" stop-color="#0369a1" stop-opacity="0.98" />
                        </linearGradient>

                        <!-- CLIP INTERNO -->
                        <clipPath id="innerClip-@t.Id">
                            <path d="
                                    M 68 86
                                    Q 140 46 212 86
                                    Q 216 92 216 102
                                    L 206 290
                                    Q 186 315 140 315
                                    Q 94 315 74 290
                                    L 64 102
                                    Q 64 92 68 86
                                    Z
                                " />
                            <!-- Base interna plana -->
                            <rect x="86" y="315" width="108" height="12" rx="0" />
                        </clipPath>

                        <!-- Onda -->
                        <path id="wavePath-@t.Id" d="
                                M 64 0
                                C 88 10, 108 -10, 132 0
                                C 156 10, 176 -10, 200 0
                                C 214 6, 220 3, 224 0
                                L 224 26
                                L 64 26
                                Z
                            " />
                    </defs>

                    <g filter="url(#shadow-@t.Id)">

                        <!-- CUERPO EXTERNO -->
                        <path d="
                                M 58 78
                                Q 140 22 222 78
                                Q 230 88 230 110
                                L 218 328
                                L 62 328
                                L 50 110
                                Q 50 88 58 78
                                Z
                            " fill="url(#plastic-@t.Id)" stroke="#040404" stroke-width="3" />

                        <!-- Base plana -->
                        <rect x="84" y="334" width="112" height="10" rx="0" fill="#050505" />
                        <rect x="88" y="336" width="104" height="6" rx="0" fill="rgba(255,255,255,0.06)" />

                        <!-- Anillo superior -->
                        <rect x="62" y="88" width="156" height="10" rx="5" fill="rgba(255,255,255,0.10)" />
                        <rect x="62" y="92" width="156" height="10" rx="5" fill="rgba(0,0,0,0.30)" />

                        <!-- Anillos del cuerpo -->
                        <g opacity="0.30">
                            <rect x="60" y="140" width="160" height="9" rx="4.5" fill="#2a2a2a" />
                            <rect x="58" y="178" width="164" height="8" rx="4" fill="#2a2a2a" />
                            <rect x="60" y="216" width="160" height="8" rx="4" fill="#2a2a2a" />
                        </g>

                        <!-- Texto principal -->
                        <text x="140" y="80" text-anchor="middle"
                              font-size="16" font-weight="800"
                              fill="#f5f5f5" style="letter-spacing:1px;">
                            Rotoplast
                        </text>

                        <!-- Texto secundario -->
                        <text x="140" y="100" text-anchor="middle"
                              font-size="12" font-weight="700"
                              fill="#e6e6e6" style="letter-spacing:0.5px;">
                            10.000 LT
                        </text>

                        <!-- Agua -->
                        <rect id="fill-@t.Id"
                              x="64" y="327"
                              width="152" height="0"
                              fill="url(#water-@t.Id)"
                              clip-path="url(#innerClip-@t.Id)"
                              style="transition: height .6s ease;" />

                        <!-- Onda -->
                        <g clip-path="url(#innerClip-@t.Id)">
                            <use id="wave-@t.Id"
                                 href="#wavePath-@t.Id"
                                 fill="rgba(255,255,255,0.22)"
                                 transform="translate(0, 327)"
                                 style="transition: transform .6s ease;" />
                        </g>

                        <!-- Brillo lateral -->
                        <path d="
                                M 66 86
                                Q 98 50 140 50
                                Q 118 66 108 96
                                L 98 312
                                Q 96 322 100 328
                                Q 86 324 80 314
                                Q 72 302 72 286
                                L 68 110
                                Q 68 96 66 86
                                Z
                            " fill="rgba(255,255,255,0.07)" />

                        <!-- Sombra interna derecha -->
                        <path d="
                                M 214 86
                                Q 190 58 156 52
                                Q 174 72 184 98
                                L 192 314
                                Q 194 322 190 328
                                Q 206 324 212 314
                                L 220 110
                                Q 220 96 214 86
                                Z
                            " fill="rgba(0,0,0,0.22)" />
                    </g>
                </svg>

                <div class="tank-stats">
                    <div><b>Nivel:</b> <span id="percent-@t.Id">0</span>%</div>
                    <div><b>Litros:</b> <span id="liters-@t.Id">0</span></div>
                </div>
            </div>
        }
    </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

<script>
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/tankHub")
        .withAutomaticReconnect()
        .build();

    connection.on("tankUpdated", (data) => {
        const id = data.tankId;
        const percent = Number(data.levelPercent);
        const liters = Number(data.volumeLiters);

        const fill = document.getElementById(`fill-${id}`);
        const wave = document.getElementById(`wave-${id}`);
        const percentSpan = document.getElementById(`percent-${id}`);
        const litersSpan = document.getElementById(`liters-${id}`);

        // Zona útil interna (altura útil = 2,7m representada en esta zona)
        const bottomY = 327;
        const topY = 102;
        const usableH = bottomY - topY;

        const waterH = (percent / 100) * usableH;
        const newY = bottomY - waterH;

        if (fill) {
            fill.setAttribute("y", newY);
            fill.setAttribute("height", waterH);
        }

        if (wave) {
            const waveY = Math.max(topY, newY - 10);
            wave.setAttribute("transform", `translate(0, ${waveY})`);
        }

        if (percentSpan) percentSpan.innerText = percent.toFixed(2);
        if (litersSpan) litersSpan.innerText = liters.toFixed(0);
    });

    connection.start()
        .then(() => console.log("SignalR conectado ✅"))
        .catch(err => console.error("Error SignalR:", err));
</script>
 *@











@model List<TankLevelControl.Models.Tank>

@{
    ViewData["Title"] = "Dashboard Tanques";
}

<style>
    body {
        background-image: url('/img/bahia.png');
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        min-height: 100vh;
    }

    .page-overlay {
        min-height: 100vh;
        background: rgba(0,0,0,0.35);
        padding: 10px 0 30px 0;
    }

    .tank-grid {
        display: flex;
        gap: 40px;
        flex-wrap: wrap;
        justify-content: center;
        align-items: flex-start;
        padding: 10px 0 30px 0;
    }

    .tank-card {
        width: 340px;
        text-align: center;
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.10);
        border-radius: 14px;
        padding: 12px 12px 16px 12px;
        backdrop-filter: blur(6px);
    }

    .tank-title {
        font-weight: 700;
        font-size: 22px;
        margin: 10px 0 2px 0;
        color: #fff;
        text-shadow: 0 2px 10px rgba(0,0,0,0.55);
    }

    .tank-stats {
        margin-top: 10px;
        font-size: 14px;
        color: #fff;
        text-shadow: 0 2px 10px rgba(0,0,0,0.55);
    }

    .badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 999px;
        background: rgba(0,0,0,0.75);
        color: #fff;
        font-size: 12px;
        letter-spacing: .3px;
        border: 1px solid rgba(255,255,255,0.15);
    }

    h2 {
        color: #fff;
        text-shadow: 0 2px 14px rgba(0,0,0,0.65);
        text-align: center;
        margin: 20px 0 10px 0;
        padding: 0 14px;
        line-height: 1.2;
    }

    .controls {
        margin-top: 10px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
    }

    .btn {
        cursor: pointer;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.16);
        background: rgba(0,0,0,0.55);
        color: #fff;
        font-weight: 700;
        font-size: 13px;
        transition: transform .08s ease;
        user-select: none;
    }

        .btn:active {
            transform: scale(0.98);
        }

    .btn-fill {
        background: rgba(16,185,129,0.35);
    }

    .btn-drain {
        background: rgba(239,68,68,0.35);
    }

    .btn-stop {
        background: rgba(107,114,128,0.45);
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .hint {
        margin-top: 8px;
        font-size: 12px;
        color: rgba(255,255,255,0.85);
        text-shadow: 0 2px 10px rgba(0,0,0,0.55);
    }

    .alert-low {
        display: none;
        margin-top: 8px;
        padding: 8px 10px;
        border-radius: 10px;
        background: rgba(239,68,68,0.22);
        border: 1px solid rgba(239,68,68,0.55);
        color: #fff;
        font-weight: 800;
        text-shadow: 0 2px 10px rgba(0,0,0,0.55);
    }
</style>

<div class="page-overlay">
    <h2>Control de Nivel de Tanques Centro de Conocimiento e Innovación Bahía de Buenaventura</h2>

    <div class="tank-grid">
        @foreach (var t in Model)
        {
            <div class="tank-card" data-device="@t.DeviceId">
                <div class="tank-title">@t.Name</div>
                <div class="tank-sub"><span class="badge">DeviceId: @t.DeviceId</span></div>

                <div class="hint">Altura: <b>@t.HeightCm</b> cm | Capacidad: <b>@t.CapacityLiters</b> L</div>

                <!-- ✅ TANQUE COMPLETO (tu mismo modelo) + agua dentro -->
                <svg width="280" height="360" viewBox="0 0 280 360" aria-label="Tanque">
                    <defs>
                        <!-- Sombra -->
                        <filter id="shadow-@t.Id" x="-20%" y="-20%" width="140%" height="140%">
                            <feDropShadow dx="0" dy="8" stdDeviation="8" flood-opacity="0.25" />
                        </filter>

                        <!-- Plástico negro -->
                        <linearGradient id="plastic-@t.Id" x1="0" y1="0" x2="1" y2="0">
                            <stop offset="0%" stop-color="#070707" />
                            <stop offset="14%" stop-color="#1a1a1a" />
                            <stop offset="35%" stop-color="#0a0a0a" />
                            <stop offset="60%" stop-color="#222" />
                            <stop offset="82%" stop-color="#0b0b0b" />
                            <stop offset="100%" stop-color="#050505" />
                        </linearGradient>

                        <!-- Agua azul -->
                        <linearGradient id="waterBlue-@t.Id" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0%" stop-color="#7dd3fc" stop-opacity="0.95" />
                            <stop offset="55%" stop-color="#0ea5e9" stop-opacity="0.95" />
                            <stop offset="100%" stop-color="#0369a1" stop-opacity="0.98" />
                        </linearGradient>

                        <!-- Agua roja (alerta) -->
                        <linearGradient id="waterRed-@t.Id" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0%" stop-color="#ff7b7b" stop-opacity="0.98" />
                            <stop offset="55%" stop-color="#ef4444" stop-opacity="0.98" />
                            <stop offset="100%" stop-color="#7f1d1d" stop-opacity="0.98" />
                        </linearGradient>

                        <!-- CLIP INTERNO -->
                        <clipPath id="innerClip-@t.Id">
                            <path d="
                                        M 68 86
                                        Q 140 46 212 86
                                        Q 216 92 216 102
                                        L 206 290
                                        Q 186 315 140 315
                                        Q 94 315 74 290
                                        L 64 102
                                        Q 64 92 68 86
                                        Z
                                    " />
                            <!-- Base interna plana -->
                            <rect x="86" y="315" width="108" height="12" rx="0" />
                        </clipPath>

                        <!-- Onda -->
                        <path id="wavePath-@t.Id" d="
                                    M 64 0
                                    C 88 10, 108 -10, 132 0
                                    C 156 10, 176 -10, 200 0
                                    C 214 6, 220 3, 224 0
                                    L 224 26
                                    L 64 26
                                    Z
                                " />
                    </defs>

                    <g filter="url(#shadow-@t.Id)">

                        <!-- CUERPO EXTERNO -->
                        <path d="
                                    M 58 78
                                    Q 140 22 222 78
                                    Q 230 88 230 110
                                    L 218 328
                                    L 62 328
                                    L 50 110
                                    Q 50 88 58 78
                                    Z
                                " fill="url(#plastic-@t.Id)" stroke="#040404" stroke-width="3" />

                        <!-- Base plana -->
                        <rect x="84" y="334" width="112" height="10" rx="0" fill="#050505" />
                        <rect x="88" y="336" width="104" height="6" rx="0" fill="rgba(255,255,255,0.06)" />

                        <!-- Anillo superior -->
                        <rect x="62" y="88" width="156" height="10" rx="5" fill="rgba(255,255,255,0.10)" />
                        <rect x="62" y="92" width="156" height="10" rx="5" fill="rgba(0,0,0,0.30)" />

                        <!-- Anillos del cuerpo -->
                        <g opacity="0.30">
                            <rect x="60" y="140" width="160" height="9" rx="4.5" fill="#2a2a2a" />
                            <rect x="58" y="178" width="164" height="8" rx="4" fill="#2a2a2a" />
                            <rect x="60" y="216" width="160" height="8" rx="4" fill="#2a2a2a" />
                        </g>

                        <!-- Texto principal -->
                        <text x="140" y="80" text-anchor="middle"
                              font-size="16" font-weight="800"
                              fill="#f5f5f5" style="letter-spacing:1px;">
                            Rotoplast
                        </text>

                        <!-- Texto secundario -->
                        <text x="140" y="100" text-anchor="middle"
                              font-size="12" font-weight="700"
                              fill="#e6e6e6" style="letter-spacing:0.5px;">
                            10.000 LT
                        </text>

                        <!-- Agua (inicia vacía). IMPORTANTE: fill lo cambiamos por JS según % -->
                        <rect id="fill-@t.Id"
                              x="64" y="327"
                              width="152" height="0"
                              fill="url(#waterBlue-@t.Id)"
                              clip-path="url(#innerClip-@t.Id)"
                              style="transition: height .6s ease, y .6s ease;" />

                        <!-- Onda -->
                        <g clip-path="url(#innerClip-@t.Id)">
                            <use id="wave-@t.Id"
                                 href="#wavePath-@t.Id"
                                 fill="rgba(255,255,255,0.22)"
                                 transform="translate(0, 327)"
                                 style="transition: transform .6s ease;" />
                        </g>

                        <!-- Brillo lateral -->
                        <path d="
                                    M 66 86
                                    Q 98 50 140 50
                                    Q 118 66 108 96
                                    L 98 312
                                    Q 96 322 100 328
                                    Q 86 324 80 314
                                    Q 72 302 72 286
                                    L 68 110
                                    Q 68 96 66 86
                                    Z
                                " fill="rgba(255,255,255,0.07)" />

                        <!-- Sombra interna derecha -->
                        <path d="
                                    M 214 86
                                    Q 190 58 156 52
                                    Q 174 72 184 98
                                    L 192 314
                                    Q 194 322 190 328
                                    Q 206 324 212 314
                                    L 220 110
                                    Q 220 96 214 86
                                    Z
                                " fill="rgba(0,0,0,0.22)" />
                    </g>
                </svg>

                <div class="tank-stats">
                    <div><b>Nivel:</b> <span id="percent-@t.Id">0</span>%</div>
                    <div><b>Litros:</b> <span id="liters-@t.Id">0</span></div>
                </div>

                <div class="alert-low" id="alert-@t.Id">⚠️ NIVEL MUY BAJO (≤ 40%)</div>

                <!-- Controles -->
                <div class="controls">
                    <button class="btn btn-fill" onclick="startFill('@t.DeviceId', @t.HeightCm)">Llenar ▶ Start</button>
                    <button class="btn btn-stop" onclick="stopSim('@t.DeviceId')">Stop ⏹</button>
                    <button class="btn btn-drain" onclick="startDrain('@t.DeviceId', @t.HeightCm)">Vaciar ▶ Start</button>
                    <button class="btn btn-stop" onclick="stopSim('@t.DeviceId')">Stop ⏹</button>
                </div>

                <div class="hint">Simulación manda lecturas cada 600ms al API.</div>
            </div>
        }
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

<script>
    // =========================
    // Estado de simulación
    // =========================
    const simTimers = {};   // { deviceId: intervalId }
    const simState = {};    // { deviceId: { distance: number } }

    const apiUrl = "/api/readings";

    async function postReading(deviceId, distanceCm) {
        // guardo “donde va” para poder continuar tras Stop
        simState[deviceId] = { distance: distanceCm };

        const res = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ deviceId, distanceCm })
        });

        if (!res.ok) {
            const txt = await res.text();
            console.error("Error POST /api/readings:", res.status, txt);
        }
    }

    function stopSim(deviceId) {
        if (simTimers[deviceId]) {
            clearInterval(simTimers[deviceId]);
            delete simTimers[deviceId];
            console.log(`⏹ Stop: ${deviceId}`);
        }
    }

    // Llenar: distance baja
    function startFill(deviceId, heightCm) {
        stopSim(deviceId);

        // ✅ arranca desde donde quedó; si no hay estado, arranca vacío (distance = heightCm)
        let dist = simState[deviceId]?.distance;
        if (dist === undefined || dist === null) dist = Math.max(10, Math.round(Number(heightCm)));

        const step = 5;
        const delay = 600;

        simTimers[deviceId] = setInterval(async () => {
            dist -= step;
            if (dist <= 10) dist = 10;

            await postReading(deviceId, dist);

            if (dist === 10) {
                stopSim(deviceId);
                console.log(`✅ ${deviceId} llegó a LLENO`);
            }
        }, delay);

        console.log(`▶ Llenar Start: ${deviceId} desde distance=${dist}`);
    }

    // Vaciar: distance sube
    function startDrain(deviceId, heightCm) {
        stopSim(deviceId);

        // ✅ arranca desde donde quedó; si no hay estado, arranca lleno (distance=10)
        let dist = simState[deviceId]?.distance;
        if (dist === undefined || dist === null) dist = 10;

        const maxDist = Math.max(10, Math.round(Number(heightCm)));
        const step = 5;
        const delay = 600;

        simTimers[deviceId] = setInterval(async () => {
            dist += step;
            if (dist >= maxDist) dist = maxDist;

            await postReading(deviceId, dist);

            if (dist === maxDist) {
                stopSim(deviceId);
                console.log(`✅ ${deviceId} llegó a VACÍO`);
            }
        }, delay);

        console.log(`▶ Vaciar Start: ${deviceId} desde distance=${dist}`);
    }

    // =========================
    // SignalR: UI en tiempo real
    // =========================
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/tankHub")
        .withAutomaticReconnect()
        .build();

    connection.on("tankUpdated", (data) => {
        const id = data.tankId;
        const deviceId = data.deviceId;
        const percent = Number(data.levelPercent);
        const liters = Number(data.volumeLiters);

        // ✅ mantenemos simState sincronizado con lecturas reales (por si llegan del ESP32)
        // Si tu backend no manda distance, no pasa nada. Pero si lo manda en el futuro, quedamos listos.
        if (data.distanceCm !== undefined && data.distanceCm !== null) {
            simState[deviceId] = { distance: Number(data.distanceCm) };
        }

        const fill = document.getElementById(`fill-${id}`);
        const wave = document.getElementById(`wave-${id}`);
        const percentSpan = document.getElementById(`percent-${id}`);
        const litersSpan = document.getElementById(`liters-${id}`);
        const alertBox = document.getElementById(`alert-${id}`);

        // Misma zona útil que ya tenías
        const bottomY = 327;
        const topY = 102;
        const usableH = bottomY - topY;

        const waterH = (percent / 100) * usableH;
        const newY = bottomY - waterH;

        if (fill) {
            fill.setAttribute("y", newY);
            fill.setAttribute("height", waterH);

            // ✅ Cambio de color (azul normal / rojo alerta)
            if (percent <= 40) {
                fill.setAttribute("fill", `url(#waterRed-${id})`);
            } else {
                fill.setAttribute("fill", `url(#waterBlue-${id})`);
            }
        }

        if (wave) {
            const waveY = Math.max(topY, newY - 10);
            wave.setAttribute("transform", `translate(0, ${waveY})`);
        }

        if (percentSpan) percentSpan.innerText = percent.toFixed(2);
        if (litersSpan) litersSpan.innerText = liters.toFixed(0);

        // ✅ Mensaje de nivel bajo
        if (alertBox) {
            alertBox.style.display = (percent <= 40) ? "block" : "none";
        }
    });

    connection.start()
        .then(() => console.log("SignalR conectado ✅"))
        .catch(err => console.error("Error SignalR:", err));
</script>
